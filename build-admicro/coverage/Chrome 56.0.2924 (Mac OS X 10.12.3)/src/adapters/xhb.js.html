<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/adapters/xhb.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">src/adapters/xhb.js</span></h1>
    <h2>
        Statements: <span class="metric">14.81% <small>(12 / 81)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">0% <small>(0 / 29)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">25% <small>(1 / 4)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">14.81% <small>(12 / 81)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">src/adapters/</a> &#187; xhb.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
var _utils = require('../utils.js');
&nbsp;
var CONSTANTS = require('../constants.json');
var utils = require('../utils.js');
var adloader = require('../adloader.js');
var bidmanager = require('../bidmanager.js');
var bidfactory = require('../bidfactory.js');
&nbsp;
var XhbAdapter = function XhbAdapter() {
&nbsp;
<span class="fstat-no" title="function not covered" >  function buildJPTCall(bid, callbackId) {</span>
    //determine tag params
<span class="cstat-no" title="statement not covered" >    var placementId = utils.getBidIdParameter('placementId', bid.params);</span>
<span class="cstat-no" title="statement not covered" >    var inventoryCode = utils.getBidIdParameter('invCode', bid.params);</span>
<span class="cstat-no" title="statement not covered" >    var referrer = utils.getBidIdParameter('referrer', bid.params);</span>
<span class="cstat-no" title="statement not covered" >    var altReferrer = utils.getBidIdParameter('alt_referrer', bid.params);</span>
&nbsp;
    //Always use https
<span class="cstat-no" title="statement not covered" >    var jptCall = 'https://ib.adnxs.com/jpt?';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'callback', 'pbjs.handleXhbCB');</span>
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'callback_uid', callbackId);</span>
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'id', placementId);</span>
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'code', inventoryCode);</span>
&nbsp;
    //sizes takes a bit more logic
<span class="cstat-no" title="statement not covered" >    var sizeQueryString = '';</span>
<span class="cstat-no" title="statement not covered" >    var parsedSizes = utils.parseSizesInput(bid.sizes);</span>
&nbsp;
    //combine string into proper querystring for impbus
<span class="cstat-no" title="statement not covered" >    var parsedSizesLength = parsedSizes.length;</span>
<span class="cstat-no" title="statement not covered" >    if (parsedSizesLength &gt; 0) {</span>
      //first value should be "size"
<span class="cstat-no" title="statement not covered" >      sizeQueryString = 'size=' + parsedSizes[0];</span>
<span class="cstat-no" title="statement not covered" >      if (parsedSizesLength &gt; 1) {</span>
        //any subsequent values should be "promo_sizes"
<span class="cstat-no" title="statement not covered" >        sizeQueryString += '&amp;promo_sizes=';</span>
<span class="cstat-no" title="statement not covered" >        for (var j = 1; j &lt; parsedSizesLength; j++) {</span>
<span class="cstat-no" title="statement not covered" >          sizeQueryString += parsedSizes[j] += ',';</span>
        }
        //remove trailing comma
<span class="cstat-no" title="statement not covered" >        if (sizeQueryString &amp;&amp; sizeQueryString.charAt(sizeQueryString.length - 1) === ',') {</span>
<span class="cstat-no" title="statement not covered" >          sizeQueryString = sizeQueryString.slice(0, sizeQueryString.length - 1);</span>
        }
      }
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (sizeQueryString) {</span>
<span class="cstat-no" title="statement not covered" >      jptCall += sizeQueryString + '&amp;';</span>
    }
&nbsp;
    //append custom attributes:
<span class="cstat-no" title="statement not covered" >    var paramsCopy = utils.extend({}, bid.params);</span>
&nbsp;
    //delete attributes already used
<span class="cstat-no" title="statement not covered" >    delete paramsCopy.placementId;</span>
<span class="cstat-no" title="statement not covered" >    delete paramsCopy.invCode;</span>
<span class="cstat-no" title="statement not covered" >    delete paramsCopy.query;</span>
<span class="cstat-no" title="statement not covered" >    delete paramsCopy.referrer;</span>
<span class="cstat-no" title="statement not covered" >    delete paramsCopy.alt_referrer;</span>
&nbsp;
    //get the reminder
<span class="cstat-no" title="statement not covered" >    var queryParams = utils.parseQueryStringParameters(paramsCopy);</span>
&nbsp;
    //append
<span class="cstat-no" title="statement not covered" >    if (queryParams) {</span>
<span class="cstat-no" title="statement not covered" >      jptCall += queryParams;</span>
    }
&nbsp;
    //append referrer
<span class="cstat-no" title="statement not covered" >    if (referrer === '') {</span>
<span class="cstat-no" title="statement not covered" >      referrer = utils.getTopWindowUrl();</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'referrer', referrer);</span>
<span class="cstat-no" title="statement not covered" >    jptCall = utils.tryAppendQueryString(jptCall, 'alt_referrer', altReferrer);</span>
&nbsp;
    //remove the trailing "&amp;"
<span class="cstat-no" title="statement not covered" >    if (jptCall.lastIndexOf('&amp;') === jptCall.length - 1) {</span>
<span class="cstat-no" title="statement not covered" >      jptCall = jptCall.substring(0, jptCall.length - 1);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return jptCall;</span>
  }
&nbsp;
  //expose the callback to the global object:
  pbjs.handleXhbCB = <span class="fstat-no" title="function not covered" >function (jptResponseObj) {</span>
<span class="cstat-no" title="statement not covered" >    var bidCode = void 0;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (jptResponseObj &amp;&amp; jptResponseObj.callback_uid) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      var responseCPM = void 0;</span>
<span class="cstat-no" title="statement not covered" >      var id = jptResponseObj.callback_uid;</span>
<span class="cstat-no" title="statement not covered" >      var placementCode = '';</span>
<span class="cstat-no" title="statement not covered" >      var bidObj = (0, _utils.getBidRequest)(id);</span>
<span class="cstat-no" title="statement not covered" >      if (bidObj) {</span>
<span class="cstat-no" title="statement not covered" >        bidCode = bidObj.bidder;</span>
<span class="cstat-no" title="statement not covered" >        placementCode = bidObj.placementCode;</span>
        //set the status
<span class="cstat-no" title="statement not covered" >        bidObj.status = CONSTANTS.STATUS.GOOD;</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      var bid = [];</span>
<span class="cstat-no" title="statement not covered" >      if (jptResponseObj.result &amp;&amp; jptResponseObj.result.ad &amp;&amp; jptResponseObj.result.ad !== '') {</span>
<span class="cstat-no" title="statement not covered" >        responseCPM = 0.00;</span>
&nbsp;
        //store bid response
        //bid status is good (indicating 1)
<span class="cstat-no" title="statement not covered" >        var adId = jptResponseObj.result.creative_id;</span>
<span class="cstat-no" title="statement not covered" >        bid = bidfactory.createBid(CONSTANTS.STATUS.GOOD, bidObj);</span>
<span class="cstat-no" title="statement not covered" >        bid.creative_id = adId;</span>
<span class="cstat-no" title="statement not covered" >        bid.bidderCode = bidCode;</span>
<span class="cstat-no" title="statement not covered" >        bid.cpm = responseCPM;</span>
<span class="cstat-no" title="statement not covered" >        bid.adUrl = jptResponseObj.result.ad;</span>
<span class="cstat-no" title="statement not covered" >        bid.width = jptResponseObj.result.width;</span>
<span class="cstat-no" title="statement not covered" >        bid.height = jptResponseObj.result.height;</span>
<span class="cstat-no" title="statement not covered" >        bid.dealId = '99999999';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        bidmanager.addBidResponse(placementCode, bid);</span>
      } else {
        //no response data
        //indicate that there is no bid for this placement
<span class="cstat-no" title="statement not covered" >        bid = bidfactory.createBid(2);</span>
<span class="cstat-no" title="statement not covered" >        bid.bidderCode = bidCode;</span>
<span class="cstat-no" title="statement not covered" >        bidmanager.addBidResponse(placementCode, bid);</span>
      }
    }
  };
&nbsp;
<span class="fstat-no" title="function not covered" >  function _callBids(params) {</span>
<span class="cstat-no" title="statement not covered" >    var bids = params.bids || [];</span>
<span class="cstat-no" title="statement not covered" >    for (var i = 0; i &lt; bids.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >      var bid = bids[i];</span>
<span class="cstat-no" title="statement not covered" >      var callbackId = bid.bidId;</span>
<span class="cstat-no" title="statement not covered" >      adloader.loadScript(buildJPTCall(bid, callbackId));</span>
    }
  }
&nbsp;
  // Export the callBids function, so that prebid.js can execute
  // this function when the page asks to send out bid requests.
  return {
    callBids: _callBids
  };
};
&nbsp;
module.exports = XhbAdapter;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Feb 15 2017 11:35:18 GMT+0700 (ICT)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
